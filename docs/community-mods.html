<!doctype html>
<html lang="en" data-bs-theme="dark">
  <head>
    <meta charset="UTF-8" />
    <title>Dota2 Minify - Community Mods</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="icon" type="image/x-icon" href="https://github.com/Egezenn/dota2-minify/raw/main/Minify/bin/images/favicon.ico" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-sRIl4kxILFvY47J16cr9ZwB07vP4J8+LH7qKQnuqkuIAvNWLzeN8tE5YBujZqJLB" crossorigin="anonymous" />
    <script type="module" src="https://unpkg.com/ionicons@7.1.0/dist/ionicons/ionicons.esm.js"></script>
    <script nomodule src="https://unpkg.com/ionicons@7.1.0/dist/ionicons/ionicons.js"></script>
    <style>
      body {
        padding-top: 2rem;
        padding-bottom: 2rem;
      }
      .mod-buttons {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 1rem;
      }
      #notes-content img {
        max-width: 100%;
        height: auto;
        border-radius: 12px;
      }
      #notes-content > div:not(:last-of-type) {
        margin-bottom: 2rem;
      }
      h1,
      h2,
      h3,
      h4,
      h5,
      h6,
      .h1,
      .h2,
      .h3,
      .h4,
      .h5,
      .h6 {
        display: flex;
        align-items: center;
        gap: 0.5rem;
      }
    </style>
  </head>
  <body>
    <main class="container">
      <div class="d-flex justify-content-between align-items-center mb-3">
        <h1 class="h1 fw-bold">Community Mods</h1>
        <a class="btn btn-primary" href="https://egezenn.github.io/dota2-minify" role="button" style="display: inline-flex; align-items: center; gap: 0.5rem"><ion-icon name="arrow-back-outline"></ion-icon> Back</a>
      </div>
      <div id="mods-section" class="mb-4" style="display: none">
        <h2 class="h4 border-bottom pb-2 mb-3">Mods</h2>
        <div id="mods-container" class="mod-buttons"></div>
      </div>

      <div id="tools-section" style="display: none">
        <h2 class="h4 border-bottom pb-2 mb-3">Tools</h2>
        <div id="tools-container" class="mod-buttons"></div>
      </div>

      <div id="skins-section" class="mt-4" style="display: none">
        <h2 class="h4 border-bottom pb-2 mb-3">Skins</h2>
        <div id="skins-container" class="mod-buttons"></div>
      </div>

      <div class="modal fade" id="notesModal" tabindex="-1" aria-labelledby="notesModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered modal-lg">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title" id="notesModalLabel">Mod Notes</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
              <div id="notes-content"></div>
            </div>
          </div>
        </div>
      </div>
    </main>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js" integrity="sha384-FKyoEForCGlyvwx9Hj09JcYn3nv7wiPVlz7YYwJrWVcXK/BmnVDxM+D2scQbITxI" crossorigin="anonymous"></script>
    <script>
      const modsContainer = document.getElementById("mods-container");
      const toolsContainer = document.getElementById("tools-container");
      const skinsContainer = document.getElementById("skins-container");
      const notesModal = new bootstrap.Modal(document.getElementById("notesModal"));
      const notesModalLabel = document.getElementById("notesModalLabel");
      const notesContent = document.getElementById("notes-content");

      const cacheKey = "github-community-data";
      const cachedData = JSON.parse(localStorage.getItem(cacheKey));
      const now = new Date().getTime();

      function createCard(item) {
        const col = document.createElement("div");
        col.className = "col";

        const card = document.createElement("div");
        card.className = "card h-100 text-center mod-card";
        card.style.cursor = "pointer";
        card.setAttribute("role", "button");

        const img = document.createElement("img");
        img.src = `https://raw.githubusercontent.com/Egezenn/dota2-minify-community/main/${encodeURIComponent(item)}/image.png`;
        img.className = "card-img-top";
        img.alt = `${item} image`;
        img.style.objectFit = "cover";
        img.style.height = "140px";
        img.onerror = function () {
          this.style.display = "none";
        };

        const cardBody = document.createElement("div");
        cardBody.className = "card-body d-flex align-items-center justify-content-center";

        const title = document.createElement("h5");
        title.className = "card-title mb-0";
        title.textContent = item;

        cardBody.appendChild(title);
        card.appendChild(img);
        card.appendChild(cardBody);

        card.addEventListener("click", () => {
          const notesCacheKey = `community-mod-notes-${item}`;
          const cachedNotes = JSON.parse(sessionStorage.getItem(notesCacheKey));
          const now = new Date().getTime();

          notesModalLabel.textContent = `${item} Notes`;
          notesModal.show();

          if (cachedNotes && now - cachedNotes.timestamp < 60000) {
            notesContent.innerHTML = cachedNotes.content;
          } else {
            const notesUrl = `https://raw.githubusercontent.com/Egezenn/dota2-minify-community/main/${encodeURIComponent(item)}/notes.html`;
            notesContent.innerHTML = "<p>Loading...</p>";

            fetch(notesUrl)
              .then((response) => {
                if (!response.ok) {
                  throw new Error("Network response was not ok");
                }
                return response.text();
              })
              .then((text) => {
                const tempDiv = document.createElement("div");
                tempDiv.innerHTML = text;
                const images = tempDiv.getElementsByTagName("img");
                for (let i = 0; i < images.length; i++) {
                  const img = images[i];
                  const src = img.getAttribute("src");
                  if (src && !src.startsWith("http")) {
                    img.src = `https://raw.githubusercontent.com/Egezenn/dota2-minify-community/main/${encodeURIComponent(item)}/${src}`;
                  }
                }
                notesContent.innerHTML = tempDiv.innerHTML;
                sessionStorage.setItem(
                  notesCacheKey,
                  JSON.stringify({
                    timestamp: now,
                    content: tempDiv.innerHTML,
                  }),
                );
              })
              .catch((error) => {
                notesContent.innerHTML = "<p>Could not load notes. The file might not exist for this mod.</p>";
                console.error("Error fetching notes:", error);
              });
          }
        });

        return card;
      }

      function processData(items, meta) {
        modsContainer.innerHTML = "";
        toolsContainer.innerHTML = "";
        skinsContainer.innerHTML = "";

        items.forEach((item) => {
          const card = createCard(item);
          // Default to 'mod' if not specified or found in meta
          const type = meta[item] && meta[item].type ? meta[item].type : "mod";

          if (type === "tool") {
            toolsContainer.appendChild(card);
          } else if (type === "skin") {
            skinsContainer.appendChild(card);
          } else {
            modsContainer.appendChild(card);
          }
        });

        document.getElementById("mods-section").style.display = modsContainer.hasChildNodes() ? "block" : "none";
        document.getElementById("tools-section").style.display = toolsContainer.hasChildNodes() ? "block" : "none";
        document.getElementById("skins-section").style.display = skinsContainer.hasChildNodes() ? "block" : "none";
      }

      if (cachedData && now - cachedData.timestamp < 60000) {
        processData(cachedData.items, cachedData.meta);
      } else {
        Promise.all([
          fetch("https://api.github.com/repos/egezenn/dota2-minify-community/contents/").then((r) => r.json()),
          fetch("https://raw.githubusercontent.com/Egezenn/dota2-minify-community/main/meta.json")
            .then((r) => r.json())
            .catch(() => ({})),
        ])
          .then(([contentsData, metaData]) => {
            const items = contentsData.filter((item) => item.type === "dir").map((item) => item.name);
            localStorage.setItem(cacheKey, JSON.stringify({ timestamp: now, items: items, meta: metaData }));
            processData(items, metaData);
          })
          .catch((error) => {
            if (cachedData) {
              processData(cachedData.items, cachedData.meta);
            }
            modsContainer.textContent = "Could not load data.";
            console.error("Error fetching data:", error);
          });
      }
    </script>
  </body>
</html>
